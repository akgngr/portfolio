---
type Project = {
  id: number;
  title: string;
  description: string;
  imageUrl: string;
  publishedAt: string;
};

const d1 = Astro.locals.runtime?.env?.DB;

if (!d1) {
  return new Response('Missing D1 binding: env.DB', { status: 500 });
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const title = String(formData.get('title') ?? '').trim();
  const description = String(formData.get('description') ?? '').trim();
  const imageUrl = String(formData.get('imageUrl') ?? '').trim();
  const publishedAt = new Date().toISOString();

  if (title.length > 0 && imageUrl.length > 0) {
    await d1
      .prepare(
        'INSERT INTO Projects (title, description, imageUrl, publishedAt) VALUES (?1, ?2, ?3, ?4)'
      )
      .bind(title, description, imageUrl, publishedAt)
      .run();

    return Astro.redirect('/admin');
  }
}

const { results } = await d1
  .prepare('SELECT id, title, description, imageUrl, publishedAt FROM Projects ORDER BY publishedAt DESC')
  .all<Project>();

const projects = results ?? [];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<title>Admin Dashboard</title>
	</head>
	<body class="bg-slate-100 min-h-screen text-slate-900">
		<main class="container mx-auto px-4 py-8 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
			    <h1 class="text-3xl font-bold text-slate-800">Admin Dashboard</h1>
                <a href="/" class="text-sky-600 hover:text-sky-700 font-medium">&larr; Back to Home</a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Project Creation Form -->
                <div class="md:col-span-1">
                    <div class="bg-white p-6 rounded-lg shadow-sm sticky top-8">
                        <h2 class="text-xl font-semibold mb-4">Add New Project</h2>
                        
                        <form method="POST" class="space-y-4" id="projectForm">
                            <!-- Image Upload Section -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Project Image</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition-colors" id="dropZone">
                                    <input type="file" id="fileInput" accept="image/*" class="hidden" />
                                    <p class="text-xs text-slate-500 mb-2" id="uploadText">Click to upload image</p>
                                    <button type="button" id="uploadBtn" class="bg-slate-200 text-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-300 transition-colors">Select File</button>
                                </div>
                                <input type="hidden" name="imageUrl" id="imageUrl" required />
                                <div id="imagePreview" class="mt-2 hidden">
                                    <img src="" alt="Preview" class="w-full h-32 object-cover rounded" />
                                    <p class="text-green-600 text-xs mt-1">Image uploaded successfully!</p>
                                </div>
                            </div>

                            <div>
                                <label for="title" class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                                <input type="text" name="title" id="title" required class="w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border" />
                            </div>

                            <div>
                                <label for="description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea name="description" id="description" rows="3" class="w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-sky-600 text-white px-4 py-2 rounded-md hover:bg-sky-700 transition-colors shadow-sm font-medium">
                                Publish Project
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Project List -->
                <div class="md:col-span-2">
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="text-xl font-semibold">Existing Projects</h2>
                        </div>
                        <ul class="divide-y divide-slate-100">
                            {projects.map((project) => (
                                <li class="p-4 hover:bg-slate-50 transition-colors flex gap-4 items-start">
                                    <img src={project.imageUrl} alt={project.title} class="w-24 h-16 object-cover rounded bg-slate-200" />
                                    <div class="flex-1">
                                        <h3 class="font-medium text-slate-800">{project.title}</h3>
                                        <p class="text-sm text-slate-500 line-clamp-2">{project.description}</p>
                                        <div class="mt-1 text-xs text-slate-400">
                                            ID: {project.id} â€¢ {new Date(project.publishedAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                </li>
                            ))}
                            {projects.length === 0 && (
                                <li class="p-8 text-center text-slate-500">
                                    No projects found. Add one using the form.
                                </li>
                            )}
                        </ul>
                    </div>
                </div>
            </div>
		</main>

		<script type="module">
      const fileInput = document.getElementById('fileInput');
      const uploadBtn = document.getElementById('uploadBtn');
      const imageUrlInput = document.getElementById('imageUrl');
      const imagePreview = document.getElementById('imagePreview');
      const uploadText = document.getElementById('uploadText');

      if (!(fileInput instanceof HTMLInputElement)) return;
      if (!(imageUrlInput instanceof HTMLInputElement)) return;
      if (!(uploadBtn instanceof HTMLButtonElement)) return;
      if (!(uploadText instanceof HTMLElement)) return;
      if (!(imagePreview instanceof HTMLElement)) return;

      uploadBtn.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        await handleUpload(file);
      });

      async function handleUpload(file) {
        uploadText.textContent = 'Uploading...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('filename', `${Date.now()}-${file.name}`);

        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (data && data.success && data.url) {
            imageUrlInput.value = data.url;

            const img = imagePreview.querySelector('img');
            if (img instanceof HTMLImageElement) {
              img.src = data.url;
            }

            imagePreview.classList.remove('hidden');
            uploadText.textContent = 'Upload complete';
          } else {
            uploadText.textContent = `Upload failed: ${data?.error ?? 'Unknown error'}`;
          }
        } catch (err) {
          console.error(err);
          uploadText.textContent = 'Upload error';
        }
      }
    </script>
	</body>
</html>
