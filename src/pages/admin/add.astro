---
// src/pages/admin/add.astro
const d1 = Astro.locals.runtime?.env?.DB;

if (!d1) {
  return new Response('Missing D1 binding: env.DB', { status: 500 });
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const title = String(formData.get('title') ?? '').trim();
  const description = String(formData.get('description') ?? '').trim();
  const imageUrl = String(formData.get('imageUrl') ?? '').trim();
  const publishedAt = new Date().toISOString();

  if (title.length > 0 && imageUrl.length > 0) {
    await d1
      .prepare(
        'INSERT INTO Projects (title, description, imageUrl, publishedAt) VALUES (?1, ?2, ?3, ?4)'
      )
      .bind(title, description, imageUrl, publishedAt)
      .run();

    return Astro.redirect('/admin');
  }
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<title>Add Project | Admin</title>
	</head>
	<body class="bg-slate-100 min-h-screen text-slate-900">
		<main class="container mx-auto px-4 py-8 max-w-2xl">
            <div class="flex justify-between items-center mb-8">
			    <h1 class="text-3xl font-bold text-slate-800">Add New Project</h1>
                <a href="/admin" class="text-sky-600 hover:text-sky-700 font-medium">&larr; Back to Dashboard</a>
            </div>

            <div class="bg-white p-8 rounded-xl shadow-md">
                <form method="POST" class="space-y-6" id="projectForm">
                    <!-- Image Upload Section -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Project Image</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors" id="dropZone">
                            <input type="file" id="fileInput" accept="image/*" class="hidden" />
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.587-1.587a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="text-sm text-slate-500 mb-4" id="uploadText">Click to upload or drag and drop</p>
                                <button type="button" id="uploadBtn" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200 transition-colors">Select Image</button>
                            </div>
                        </div>
                        <input type="hidden" name="imageUrl" id="imageUrl" required />
                        <div id="imagePreview" class="mt-4 hidden">
                            <img src="" alt="Preview" class="w-full h-48 object-cover rounded-xl shadow-sm" />
                            <p class="text-green-600 text-xs mt-2 font-medium">Image uploaded successfully!</p>
                        </div>
                    </div>

                    <div>
                        <label for="title" class="block text-sm font-semibold text-slate-700 mb-1">Project Title</label>
                        <input type="text" name="title" id="title" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 p-3 border" placeholder="My Awesome Project" />
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-semibold text-slate-700 mb-1">Description</label>
                        <textarea name="description" id="description" rows="4" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 p-3 border" placeholder="Tell us more about it..."></textarea>
                    </div>

                    <button type="submit" class="w-full bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 transition-colors shadow-lg font-bold text-lg">
                        Publish Project
                    </button>
                </form>
            </div>
		</main>

		<script>
      const fileInput = document.getElementById('fileInput') as HTMLInputElement;
      const uploadBtn = document.getElementById('uploadBtn') as HTMLButtonElement;
      const imageUrlInput = document.getElementById('imageUrl') as HTMLInputElement;
      const imagePreview = document.getElementById('imagePreview') as HTMLDivElement;
      const uploadText = document.getElementById('uploadText') as HTMLElement;

      uploadBtn?.addEventListener('click', () => fileInput?.click());

      fileInput?.addEventListener('change', async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        await handleUpload(file);
      });

      async function handleUpload(file: File) {
        if (!uploadText) return;
        uploadText.textContent = 'Uploading...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('filename', `${Date.now()}-${file.name}`);

        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (data && data.success && data.url) {
            if (imageUrlInput) imageUrlInput.value = data.url;

            const img = imagePreview?.querySelector('img');
            if (img) img.src = data.url;

            imagePreview?.classList.remove('hidden');
            uploadText.textContent = 'Upload complete';
          } else {
            uploadText.textContent = `Upload failed: ${data?.error ?? 'Unknown error'}`;
          }
        } catch (err) {
          console.error(err);
          uploadText.textContent = 'Upload error';
        }
      }
    </script>
	</body>
</html>
