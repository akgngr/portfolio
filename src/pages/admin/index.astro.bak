---
// src/pages/admin/index.astro
type Project = {
  id: number;
  title: string;
  description: string;
  imageUrl: string;
  publishedAt: string;
};

const d1 = Astro.locals.runtime?.env?.DB;
const user = Astro.locals.user;

if (!d1) {
  return new Response('Missing D1 binding: env.DB', { status: 500 });
}

const { results } = await d1
  .prepare('SELECT id, title, description, imageUrl, publishedAt FROM Projects ORDER BY publishedAt DESC')
  .all<Project>();

const projects = results ?? [];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<title>Dashboard | Admin</title>
	</head>
	<body class="bg-slate-50 min-h-screen text-slate-900">
        <!-- Navigation -->
        <nav class="bg-white border-b border-slate-200">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-slate-800">Portfolio Admin</h1>
                    <span class="bg-sky-100 text-sky-700 text-xs px-2 py-1 rounded font-medium">Zero Trust Active</span>
                </div>
                <div class="flex items-center gap-6 text-sm">
                    <span class="text-slate-500">Logged in as: <strong class="text-slate-800">{user?.email}</strong></span>
                    <a href="/" class="hover:text-sky-600 transition-colors">View Site</a>
                    <a href="https://portfolio-admin-os.cloudflareaccess.com/cdn-cgi/access/logout" class="bg-red-50 text-red-600 px-3 py-1 rounded hover:bg-red-100 transition-colors">Logout</a>
                </div>
            </div>
        </nav>

		<main class="container mx-auto px-4 py-12 max-w-5xl">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-900">Projects Dashboard</h2>
                    <p class="text-slate-500 mt-1">Manage your portfolio items and showcase your work.</p>
                </div>
                <a href="/admin/add" class="bg-sky-600 text-white px-5 py-2.5 rounded-lg font-bold hover:bg-sky-700 transition-all shadow-lg shadow-sky-100">
                    + Add New Project
                </a>
            </div>

            <!-- Projects Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 text-sm font-semibold text-slate-600">Project Details</th>
                            <th class="px-6 py-4 text-sm font-semibold text-slate-600">Date Published</th>
                            <th class="px-6 py-4 text-sm font-semibold text-slate-600 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {projects.map((project) => (
                            <tr class="group hover:bg-slate-50/50 transition-colors">
                                <td class="px-6 py-5">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-12 rounded-lg bg-slate-100 overflow-hidden border border-slate-200">
                                            <img src={project.imageUrl} alt="" class="w-full h-full object-cover" />
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-800 group-hover:text-sky-600 transition-colors">{project.title}</div>
                                            <div class="text-sm text-slate-500 line-clamp-1 max-w-md">{project.description}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-5 text-sm text-slate-500">
                                    {new Date(project.publishedAt).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <button 
                                        onclick={`deleteProject(${project.id})`}
                                        class="text-slate-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-all"
                                        title="Delete Project"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        ))}
                        {projects.length === 0 && (
                            <tr>
                                <td colspan="3" class="px-6 py-20 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                            </svg>
                                        </div>
                                        <p class="text-slate-400 font-medium">No projects found. Start by adding your first project!</p>
                                        <a href="/admin/add" class="text-sky-600 hover:underline mt-2 text-sm">Add project &rarr;</a>
                                    </div>
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
		</main>

        <script is:inline>
            async function deleteProject(id) {
                if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;
                
                try {
                    const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const data = await res.json();
                        alert('Failed to delete project: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('An error occurred while deleting the project.');
                }
            }
        </script>
	</body>
</html>
