---
// src/pages/projects/[id].astro
import Layout from '../../layouts/Layout.astro';
import { ArrowLeft, ExternalLink, Github, Calendar, User, Layers, CheckCircle } from 'lucide-react';
import { getProjectById, getProjects } from '../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime?.env?.DB;

if (!db || !id) {
  return Astro.redirect('/404');
}

const project = await getProjectById(db, id);
if (!project) {
  return Astro.redirect('/404');
}

const allProjects = await getProjects(db);
const currentIndex = allProjects.findIndex(p => p.id === id);
const nextProject = allProjects[(currentIndex + 1) % allProjects.length];
---

<Layout title={project.title} description={project.description}>
    <article class="pt-32 pb-20 min-h-screen">
      {/* Header / Hero */}
      <div class="max-w-7xl mx-auto px-6 mb-16">
        <a 
            href="/projects"
            class="group inline-flex items-center gap-2 text-text-muted hover:text-white transition-colors mb-8 text-sm font-medium"
        >
            <ArrowLeft size={16} className="group-hover:-translate-x-1 transition-transform" />
            Back to Projects
        </a>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-end">
            <div>
                <span class="inline-block py-1.5 px-4 rounded-full bg-primary/10 border border-primary/20 text-primary text-xs font-bold uppercase tracking-wider mb-6">
                    {project.category}
                </span>
                <h1 class="text-4xl md:text-6xl font-bold text-white tracking-tight mb-6 leading-[1.1]">
                    {project.title}
                </h1>
                <p class="text-xl text-text-body leading-relaxed max-w-2xl">
                    {project.description}
                </p>
            </div>
            
            <div class="flex flex-col gap-6 lg:items-end">
                 <div class="flex flex-wrap gap-4">
                    {project.demoUrl && project.demoUrl !== '#' && (
                        <a href={project.demoUrl} target="_blank" class="px-6 py-3 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 transition-colors inline-flex items-center">
                            Live Demo <ExternalLink size={16} className="ml-2" />
                        </a>
                    )}
                    {project.githubUrl && project.githubUrl !== '#' && (
                        <a href={project.githubUrl} target="_blank" class="px-6 py-3 bg-surface text-white border border-white/10 rounded-lg text-sm font-bold hover:bg-surface/80 transition-colors inline-flex items-center">
                            Source Code <Github size={16} className="ml-2" />
                        </a>
                    )}
                 </div>
            </div>
        </div>
      </div>

      {/* Main Feature Image */}
      <div class="max-w-7xl mx-auto px-6 mb-20">
         <div class="aspect-video w-full rounded-2xl overflow-hidden border border-white/10 relative shadow-2xl">
             <div class="absolute inset-0 bg-surface/20 z-10"></div>
             <img 
                src={project.imageUrl} 
                alt={project.title} 
                class="w-full h-full object-cover"
             />
         </div>
      </div>

      {/* Content Grid */}
      <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-16">
         {/* Main Content (Left 2/3) */}
         <div class="lg:col-span-2 space-y-12">
            <div>
                <h3 class="text-2xl font-bold text-white mb-6">Overview</h3>
                <p class="text-text-body text-lg leading-loose">
                    {project.longDescription || project.description}
                </p>
            </div>

            {project.gallery && project.gallery.length > 0 && (
                <div>
                     <h3 class="text-2xl font-bold text-white mb-6">Project Gallery</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         {project.gallery.map((img: string | null | undefined, i: any) => (
                             <div class="rounded-xl overflow-hidden border border-white/10 hover:border-white/20 transition-all">
                                 <img src={img} alt={`Gallery ${i}`} class="w-full h-auto object-cover hover:scale-105 transition-transform duration-500" />
                             </div>
                         ))}
                     </div>
                </div>
            )}
         </div>

         {/* Sidebar (Right 1/3) */}
         <div class="space-y-8">
            {/* Project Info Card */}
            <div class="bg-[#1e212f] rounded-xl p-8 border border-white/5 space-y-6">
                <h4 class="text-white font-bold text-lg mb-4">Project Info</h4>
                
                <div class="flex items-center gap-4">
                    <div class="p-2.5 bg-white/5 rounded-lg text-text-muted">
                        <User size={20} />
                    </div>
                    <div>
                        <span class="block text-xs text-text-muted uppercase tracking-wider font-bold">Role</span>
                        <span class="text-white font-medium">{project.role || 'Developer'}</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="p-2.5 bg-white/5 rounded-lg text-text-muted">
                        <Calendar size={20} />
                    </div>
                    <div>
                        <span class="block text-xs text-text-muted uppercase tracking-wider font-bold">Year</span>
                        <span class="text-white font-medium">{project.year || '2023'}</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="p-2.5 bg-white/5 rounded-lg text-text-muted">
                        <Layers size={20} />
                    </div>
                    <div>
                        <span class="block text-xs text-text-muted uppercase tracking-wider font-bold">Stack</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                             {project.tags.map((tag: unknown) => (
                                 <span class="text-xs text-text-body bg-black/30 px-2 py-1 rounded border border-white/5">
                                     {tag}
                                 </span>
                             ))}
                        </div>
                    </div>
                </div>
            </div>

            {/* Key Features */}
            {project.features && project.features.length > 0 && (
                <div class="bg-[#1e212f] rounded-xl p-8 border border-white/5">
                     <h4 class="text-white font-bold text-lg mb-6">Key Features</h4>
                     <ul class="space-y-4">
                         {project.features.map((feature: unknown) => (
                             <li class="flex items-start gap-3 text-text-body text-sm">
                                 <CheckCircle size={16} className="text-primary mt-0.5 shrink-0" />
                                 {feature}
                             </li>
                         ))}
                     </ul>
                </div>
            )}
         </div>
      </div>

      {/* Next Project Nav */}
      <div class="max-w-7xl mx-auto px-6 mt-32">
          <div class="border-t border-white/10 pt-12 flex flex-col md:flex-row justify-between items-center gap-6">
              <span class="text-text-muted font-mono uppercase tracking-widest text-sm">Next Project</span>
              <a 
                href={`/projects/${nextProject.id}`}
                class="group text-center md:text-right"
              >
                  <h4 class="text-3xl font-bold text-white group-hover:text-primary transition-colors mb-2">
                      {nextProject.title}
                  </h4>
                  <div class="flex items-center justify-center md:justify-end gap-2 text-text-body group-hover:translate-x-2 transition-transform">
                      View Case Study <ArrowLeft className="rotate-180" size={20} />
                  </div>
              </a>
          </div>
      </div>
    </article>
</Layout>
